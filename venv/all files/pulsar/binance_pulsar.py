import websocket
import threading
import time
import json
import pandas as pd
from bd_case import connect_to_db, update_or_insert_trade_pairs
from pulsar import Client

# List of currency pairs
currency_pairs = ['ethbtc', 'ltcbtc', 'bnbbtc', 'neobtc', 'qtumeth', 'eoseth', 'snteth', 'bnteth', 'gasbtc', 'bnbeth', 'btcusdt', 'ethusdt', 'wtcbtc', 'lrcbtc', 'lrceth', 'qtumbtc', 'zrxbtc', 'kncbtc', 'funeth', 'snmbtc', 'neoeth', 'iotabtc', 'iotaeth', 'linkbtc', 'linketh', 'xvgeth', 'mtlbtc', 'mtleth', 'eosbtc', 'sntbtc', 'etceth', 'etcbtc', 'zecbtc', 'zeceth', 'bntbtc', 'astbtc', 'dashbtc', 'dasheth', 'oaxbtc', 'reqbtc', 'vibbtc', 'trxbtc', 'trxeth', 'powrbtc', 'powreth', 'xrpbtc', 'xrpeth', 'enjbtc', 'enjeth', 'storjbtc', 'bnbusdt', 'kmdbtc', 'nulsbtc', 'xmrbtc', 'xmreth', 'ambbtc', 'batbtc', 'bateth', 'neousdt', 'neobnb', 'lskbtc', 'lsketh', 'manabtc', 'manaeth', 'iotabnb', 'adxbtc', 'adxeth', 'adabtc', 'adaeth', 'xlmbtc', 'xlmeth', 'xlmbnb', 'ltceth', 'ltcusdt', 'ltcbnb', 'wavesbtc', 'waveseth', 'icxbtc', 'elfbtc', 'elfeth', 'rlcbtc', 'rlceth', 'pivxbtc', 'iostbtc', 'iosteth', 'steembtc', 'steemeth', 'blzbtc', 'zilbtc', 'zileth', 'zilbnb', 'ontbtc', 'qtumusdt', 'wanbtc', 'waneth', 'sysbtc', 'adausdt', 'adabnb', 'loombtc', 'xrpusdt', 'btctusd', 'ethtusd', 'zenbtc', 'zeneth', 'eosusdt', 'eosbnb', 'thetabtc', 'thetaeth', 'thetabnb', 'xrpbnb', 'tusdusdt', 'iotausdt', 'xlmusdt', 'iotxbtc', 'iotxeth', 'qkcbtc', 'qkceth', 'databtc', 'ontusdt', 'trxbnb', 'trxusdt', 'etcusdt', 'etcbnb', 'icxusdt', 'sceth', 'denteth', 'ardrbtc', 'nulsusdt', 'hoteth', 'vetbtc', 'veteth', 'vetusdt', 'vetbnb', 'dockbtc', 'rvnbtc', 'dcrbtc', 'renbtc', 'bnbtusd', 'xrptusd', 'bnbusdc', 'btcusdc', 'ethusdc', 'usdcusdt', 'adatusd', 'trxxrp', 'linkusdt', 'wavesusdt', 'ltctusd', 'ongbtc', 'ongusdt', 'hotusdt', 'zilusdt', 'zrxusdt', 'fetbnb', 'fetbtc', 'fetusdt', 'batusdt', 'xmrbnb', 'xmrusdt', 'zecusdt', 'iostusdt', 'celrbnb', 'celrbtc', 'celrusdt', 'dashusdt', 'omgusdt', 'thetausdt', 'enjusdt', 'maticbnb', 'maticbtc', 'maticusdt', 'atombnb', 'atombtc', 'atomusdt', 'phbbtc', 'tfuelbtc', 'tfuelusdt', 'onebnb', 'onebtc', 'oneusdt', 'ftmbnb', 'ftmbtc', 'ftmusdt', 'algobnb', 'algobtc', 'algousdt', 'dogebtc', 'dogeusdt', 'duskbtc', 'duskusdt', 'ankrbnb', 'ankrbtc', 'ankrusdt', 'winbnb', 'winusdt', 'cosbnb', 'cosbtc', 'cosusdt', 'mtlusdt', 'tomobtc', 'tomousdt', 'perlusdt', 'dentusdt', 'keyusdt', 'dockusdt', 'wanusdt', 'funusdt', 'cvcusdt', 'wintrx', 'chzbnb', 'chzbtc', 'chzusdt', 'bandbtc', 'bandusdt', 'bnbbusd', 'btcbusd', 'busdusdt', 'xtzbtc', 'xtzusdt', 'renusdt', 'rvnusdt', 'hbarbnb', 'hbarbtc', 'hbarusdt', 'nknbtc', 'nknusdt', 'xrpbusd', 'ethbusd', 'ltcbusd', 'linkbusd', 'etcbusd', 'stxbnb', 'stxbtc', 'stxusdt', 'kavabnb', 'kavabtc', 'kavausdt', 'btcngn', 'arpabnb', 'arpabtc', 'arpausdt', 'trxbusd', 'eosbusd', 'iotxusdt', 'rlcusdt', 'xlmbusd', 'adabusd', 'ctxcbtc', 'ctxcusdt', 'bchbnb', 'bchbtc', 'bchusdt', 'bchtusd', 'bchbusd', 'btcrub', 'ethrub', 'xrprub', 'bnbrub', 'troyusdt', 'busdrub', 'qtumbusd', 'vetbusd', 'vitebtc', 'viteusdt', 'btctry', 'bnbtry', 'busdtry', 'ethtry', 'xrptry', 'usdttry', 'usdtrub', 'btceur', 'etheur', 'bnbeur', 'xrpeur', 'eurbusd', 'eurusdt', 'ognbtc', 'ognusdt', 'drepbtc', 'drepusdt', 'wrxusdt', 'icxbusd', 'btsusdt', 'lskusdt', 'bntusdt', 'bntbusd', 'ltobtc', 'ltousdt', 'atombusd', 'dashbusd', 'neobusd', 'wavesbusd', 'xtzbusd', 'batbusd', 'enjbusd', 'ontbusd', 'rvnbusd', 'mblusdt', 'cotibnb', 'cotibtc', 'cotiusdt', 'algobusd', 'tomobusd', 'xmrbusd', 'zecbusd', 'stptbtc', 'stptusdt', 'btczar', 'ethzar', 'usdtzar', 'busdzar', 'wtcusdt', 'databusd', 'datausdt', 'solbnb', 'solbtc', 'solusdt', 'solbusd', 'usdtidrt', 'ctsibtc', 'ctsiusdt', 'ctsibnb', 'ctsibusd', 'hivebtc', 'hiveusdt', 'chrbnb', 'chrbtc', 'chrusdt', 'btcupusdt', 'btcdownusdt', 'ardrusdt', 'hbarbusd', 'maticbusd', 'wrxbusd', 'zilbusd', 'mdtbtc', 'mdtusdt', 'stmxusdt', 'kncbusd', 'kncusdt', 'lrcbusd', 'lrcusdt', 'iqbusd', 'pntusdt', 'btcgbp', 'ethgbp', 'xrpgbp', 'bnbgbp', 'gbpbusd', 'dgbbtc', 'dgbbusd', 'btcuah', 'usdtuah', 'compbtc', 'compbusd', 'compusdt', 'btcbidr', 'ethbidr', 'bnbbidr', 'busdbidr', 'usdtbidr', 'scusdt', 'zenusdt', 'sxpbtc', 'sxpbnb', 'sxpbusd', 'snxbtc', 'snxbnb', 'snxbusd', 'snxusdt', 'ethupusdt', 'ethdownusdt', 'adaupusdt', 'adadownusdt', 'vthousdt', 'dgbusdt', 'gbpusdt', 'storjbusd', 'sxpusdt', 'irisbtc', 'mkrbtc', 'mkrusdt', 'mkrbusd', 'runebnb', 'runebtc', 'runebusd', 'manabusd', 'dogebusd', 'zrxbusd', 'dcrusdt', 'storjusdt', 'fiobtc', 'bnbupusdt', 'bnbdownusdt', 'avabtc', 'avabusd', 'iotabusd', 'manausdt', 'balbtc', 'balbusd', 'yfibtc', 'yfibusd', 'yfiusdt', 'balusdt', 'blzusdt', 'irisusdt', 'kmdusdt', 'btcdai', 'ethdai', 'bnbdai', 'usdtdai', 'busddai', 'jstbtc', 'jstbusd', 'jstusdt', 'srmbusd', 'antbnb', 'antbtc', 'antbusd', 'antusdt', 'crvbtc', 'crvbusd', 'crvusdt', 'sandbnb', 'sandbtc', 'sandusdt', 'sandbusd', 'oceanbnb', 'oceanbtc', 'oceanbusd', 'oceanusdt', 'nmrbtc', 'nmrbusd', 'nmrusdt', 'dotbnb', 'dotbtc', 'dotbusd', 'dotusdt', 'lunabusd', 'lunausdt', 'idexbtc', 'idexbusd', 'rsrbnb', 'rsrbusd', 'rsrusdt', 'paxgbnb', 'paxgbtc', 'paxgbusd', 'paxgusdt', 'wnxmusdt', 'trbbtc', 'trbbusd', 'trbusdt', 'wbtcbtc', 'wbtceth', 'sushibnb', 'sushibtc', 'sushibusd', 'sushiusdt', 'yfiiusdt', 'ksmbtc', 'ksmbusd', 'ksmusdt', 'egldbnb', 'egldbtc', 'egldbusd', 'egldusdt', 'diabtc', 'diabusd', 'diausdt', 'runeusdt', 'fiousdt', 'umabtc', 'umausdt', 'linktry', 'usdtngn', 'belbnb', 'belbtc', 'belbusd', 'belusdt', 'wingbtc', 'wingbusd', 'wingusdt', 'creambusd', 'unibnb', 'unibtc', 'unibusd', 'uniusdt', 'oxtbtc', 'oxtusdt', 'sunusdt', 'avaxbnb', 'avaxbtc', 'avaxbusd', 'avaxusdt', 'bakebnb', 'flmbtc', 'flmusdt', 'scrtbtc', 'scrteth', 'cakebnb', 'cakebusd', 'ornbtc', 'ornusdt', 'sxptry', 'utkbtc', 'utkusdt', 'xvsbnb', 'xvsbtc', 'xvsbusd', 'xvsusdt', 'alphabtc', 'alphabusd', 'alphausdt', 'vidtbtc', 'vidtbusd', 'aavebnb', 'btcbrl', 'usdtbrl', 'aavebtc', 'aaveeth', 'aavebusd', 'aaveusdt', 'nearbnb', 'nearbtc', 'nearbusd', 'nearusdt', 'filbnb', 'filbtc', 'filbusd', 'filusdt', 'injbnb', 'injbtc', 'injbusd', 'injusdt', 'aergobtc', 'aergobusd', 'linkeur', 'onebusd', 'audiobtc', 'audiobusd', 'audiousdt', 'ctkbnb', 'ctkbtc', 'ctkbusd', 'ctkusdt', 'ethbrl', 'doteur', 'akrousdt', 'kp3rbusd', 'axsbnb', 'axsbtc', 'axsbusd', 'axsusdt', 'hardbnb', 'hardbtc', 'hardbusd', 'hardusdt', 'bnbbrl', 'ltceur', 'slpeth', 'adaeur', 'cvpbusd', 'straxbtc', 'straxbusd', 'straxusdt', 'forbtc', 'forbusd', 'unfibtc', 'unfibusd', 'unfiusdt', 'frontbusd', 'rosebtc', 'rosebusd', 'roseusdt', 'avaxtry', 'busdbrl', 'avausdt', 'sysbusd', 'xemusdt', 'prombusd', 'xrpbrl', 'sklbtc', 'sklbusd', 'sklusdt', 'bcheur', 'yfieur', 'zilbidr', 'glmbtc', 'linkbrl', 'ltcrub', 'trxtry', 'xlmeur', 'dfbusd', 'grtbtc', 'grteth', 'grtusdt', 'juvbusd', 'juvusdt', 'psgbtc', 'psgbusd', 'psgusdt', '1inchbtc', '1inchusdt', 'reefusdt', 'ogbtc', 'ogusdt', 'atmusdt', 'asrusdt', 'celobtc', 'celousdt', 'rifbtc', 'rifusdt', 'chztry', 'xlmtry', 'linkgbp', 'grteur', 'trubtc', 'truusdt', 'dexeeth', 'dexebusd', 'eoseur', 'ltcbrl', 'tusdbusd', 'ckbbusd', 'ckbusdt', 'twtbtc', 'twtbusd', 'twtusdt', 'firobtc', 'firousdt', 'betheth', 'dogeeur', 'dogetry', 'dogebrl', 'litbtc', 'litbusd', 'litusdt', 'busdvai', 'sfpbtc', 'sfpbusd', 'sfpusdt', 'dogegbp', 'dottry', 'fxsbtc', 'fxsbusd', 'dodobtc', 'dodobusd', 'dodousdt', 'frontbtc', 'cakebtc', 'cakeusdt', 'bakebusd', 'ufteth', 'uftbusd', '1inchbusd', 'bandbusd', 'grtbusd', 'iostbusd', 'omgbusd', 'reefbusd', 'acmbusd', 'acmusdt', 'auctionbtc', 'auctionbusd', 'phabtc', 'phabusd', 'dotgbp', 'adatry', 'adabrl', 'adagbp', 'tvkbtc', 'tvkbusd', 'badgerbtc', 'badgerbusd', 'badgerusdt', 'fisbtc', 'fisbusd', 'fisusdt', 'dotbrl', 'hottry', 'egldeur', 'ombtc', 'ombusd', 'omusdt', 'pondbtc', 'pondbusd', 'pondusdt', 'degobtc', 'degobusd', 'degousdt', 'avaxeur', 'chzbrl', 'alicebtc', 'alicebusd', 'aliceusdt', 'chzbusd', 'chzeur', 'chzgbp', 'linabtc', 'linabusd', 'linausdt', 'adarub', 'enjbrl', 'enjeur', 'maticeur', 'neotry', 'perpbtc', 'perpbusd', 'perpusdt', 'superbtc', 'superbusd', 'superusdt', 'cfxbtc', 'cfxbusd', 'cfxusdt', 'eostry', 'ltcgbp', 'rvntry', 'thetaeur', 'xvgbusd', 'tkobtc', 'tkobidr', 'tkobusd', 'tkousdt', 'pundixeth', 'pundixusdt', 'wineur', 'tlmbtc', 'tlmbusd', 'tlmusdt', 'hotbusd', 'bnbuah', 'onttry', 'veteur', 'vetgbp', 'winbrl', 'barbusd', 'barusdt', 'forthbtc', 'forthbusd', 'forthusdt', 'bakeusdt', 'burgerbusd', 'burgerusdt', 'slpbusd', 'slpusdt', 'trxeur', 'vettry', 'shibusdt', 'shibbusd', 'icpbtc', 'icpbnb', 'icpbusd', 'icpusdt', 'shibeur', 'etceur', 'dogebidr', 'arbtc', 'arbusd', 'arusdt', 'polsbtc', 'polsbnb', 'polsbusd', 'polsusdt', 'mdxbtc', 'mdxbusd', 'mdxusdt', 'maskbnb', 'maskbusd', 'maskusdt', 'lptbtc', 'lptbnb', 'lptbusd', 'lptusdt', 'ethuah', 'maticbrl', 'soleur', 'shibbrl', 'agixbtc', 'icpeur', 'maticgbp', 'shibtry', 'maticbidr', 'maticrub', 'xvgusdt', 'celrbusd', 'atmbusd', 'zenbusd', 'ftmbusd', 'thetabusd', 'kavabusd', 'atabtc', 'atabusd', 'atausdt', 'gtcbtc', 'gtcbusd', 'gtcusdt', 'tornbusd', 'matictry', 'solgbp', 'bakebtc', 'cotibusd', 'soltry', 'runegbp', 'solbrl', 'chrbusd', 'stmxbusd', 'fttbusd', 'dockbusd', 'adabidr', 'ernbusd', 'ernusdt', 'klaybtc', 'klaybusd', 'klayusdt', 'runeeur', 'dotrub', 'utkbusd', 'iotxbusd', 'phausdt', 'solrub', 'busduah', 'bondbtc', 'bondbusd', 'bondusdt', 'mlnbtc', 'mlnusdt', 'grttry', 'dexeusdt', 'ltobusd', 'adxbusd', 'quickbtc', 'quickbusd', 'c98usdt', 'c98busd', 'c98btc', 'clvbtc', 'clvbusd', 'clvusdt', 'qntbtc', 'qntbusd', 'qntusdt', 'flowbtc', 'flowbnb', 'flowbusd', 'flowusdt', 'xecbusd', 'tvkusdt', 'minabtc', 'minabusd', 'minausdt', 'raybnb', 'raybusd', 'rayusdt', 'farmbtc', 'farmbusd', 'farmusdt', 'alpacabtc', 'alpacabusd', 'alpacausdt', 'tlmtry', 'quickusdt', 'ornbusd', 'mboxbtc', 'mboxbnb', 'mboxbusd', 'mboxusdt', 'forusdt', 'requsdt', 'ghstusdt', 'waxpusdt', 'waxpbusd', 'waxpbtc', 'gnousdt', 'arpatry', 'prombtc', 'mtlbusd', 'ognbusd', 'xecusdt', 'xrpbidr', 'elfusdt', 'dydxusdt', 'dydxbusd', 'dydxbnb', 'dydxbtc', 'elfbusd', 'idexusdt', 'vidtusdt', 'solbidr', 'usdpusdt', 'galausdt', 'galabusd', 'galabnb', 'galabtc', 'sunbusd', 'ilvusdt', 'ilvbusd', 'ilvbtc', 'renbusd', 'yggusdt', 'yggbusd', 'yggbtc', 'stxbusd', 'sysusdt', 'dfusdt', 'arparub', 'ltcuah', 'fetbusd', 'arpabusd', 'lskbusd', 'fidausdt', 'fidabusd', 'avaxeth', 'fidabtc', 'dentbusd', 'frontusdt', 'cvpusdt', 'agldbtc', 'agldbusd', 'agldusdt', 'radbtc', 'radbusd', 'radusdt', 'hivebusd', 'betabtc', 'betabnb', 'betabusd', 'betausdt', 'rarebtc', 'rarebusd', 'rareusdt', 'avaxbrl', 'troybusd', 'axseth', 'ftmeth', 'soleth', 'ssvbtc', 'ssveth', 'laziotry', 'lazioeur', 'laziobtc', 'laziousdt', 'chessbtc', 'chessbusd', 'chessusdt', 'scrtbusd', 'adxusdt', 'auctionusdt', 'celobusd', 'reeftry', 'shibdoge', 'darusdt', 'darbusd', 'darbnb', 'darbtc', 'bnxbtc', 'bnxbnb', 'bnxbusd', 'bnxusdt', 'laziobusd', 'manatry', 'algorub', 'movrbtc', 'movrbusd', 'movrusdt', 'citybtc', 'citybusd', 'cityusdt', 'ensbtc', 'ensbnb', 'ensbusd', 'ensusdt', 'sandeth', 'doteth', 'maticeth', 'ankrbusd', 'sandtry', 'manabrl', 'kp3rusdt', 'qiusdt', 'qibusd', 'qibtc', 'portobtc', 'portousdt', 'portotry', 'portoeur', 'powrusdt', 'slptry', 'lrctry', 'chreth', 'vgxusdt', 'galaeth', 'jasmyusdt', 'jasmybusd', 'ampbusd', 'ampusdt', 'plabtc', 'plabusd', 'plausdt', 'pyrbtc', 'pyrbusd', 'pyrusdt', 'rndrbtc', 'rndrusdt', 'rndrbusd', 'alcxbtc', 'alcxbusd', 'alcxusdt', 'santosbtc', 'santosusdt', 'santostry', 'mcbtc', 'mcbusd', 'mcusdt', 'beltry', 'denttry', 'enjtry', 'neorub', 'bicobtc', 'bicobusd', 'bicousdt', 'fluxbtc', 'fluxbusd', 'fluxusdt', 'alicetry', 'fxsusdt', 'galabrl', 'galatry', 'lunatry', 'reqbusd', 'sandbrl', 'voxelbtc', 'voxelbusd', 'voxelusdt', 'cosbusd', 'ctxcbusd', 'ftmtry', 'minatry', 'xtztry', 'highbtc', 'highbusd', 'highusdt', 'cvxbtc', 'cvxbusd', 'cvxusdt', 'peoplebtc', 'peoplebusd', 'peopleusdt', 'ookibusd', 'ookiusdt', 'linkbnb', 'mdtbusd', 'nulsbusd', 'spellusdt', 'spellbusd', 'joebtc', 'joebusd', 'joeusdt', 'atometh', 'duskbusd', 'egldeth', 'icpeth', 'neareth', 'atomtry', 'lrcbnb', 'achbtc', 'achbusd', 'achusdt', 'imxbtc', 'imxbusd', 'imxusdt', 'glmrbtc', 'glmrbusd', 'glmrusdt', 'icptry', 'roseeth', 'umabusd', 'unieth', 'lokabtc', 'lokabnb', 'lokabusd', 'lokausdt', 'crveth', 'highbnb', 'nearrub', 'rosetry', 'scrtusdt', 'api3btc', 'api3usdt', 'bttcusdt', 'bttctry', 'acabtc', 'acabusd', 'acausdt', 'bdotdot', 'xnobtc', 'xnobusd', 'xnousdt', 'costry', 'kavaeth', 'onetry', 'woobtc', 'woobnb', 'woobusd', 'woousdt', 'spelltry', 'tfuelbusd', 'axstry', 'dartry', 'neartry', 'idexbnb', 'alpineeur', 'alpinetry', 'alpineusdt', 'alpinebtc', 'tusdt', 'tbusd', 'betaeth', 'injtry', 'astrbusd', 'astrusdt', 'api3try', 'mboxtry', 'gmtbtc', 'gmtbnb', 'gmtbusd', 'gmtusdt', 'atomeur', 'galaeur', 'umatry', 'kdabtc', 'kdabusd', 'kdausdt', 'apeusdt', 'apebusd', 'apebtc', 'alpinebusd', 'neareur', 'twttry', 'waveseur', 'apeeur', 'apetry', 'bswusdt', 'bswbusd', 'bswbnb', 'apebnb', 'gmteth', 'jasmytry', 'santosbusd', 'bifiusdt', 'gmteur', 'imxbnb', 'runeeth', 'multibtc', 'multibusd', 'multiusdt', 'apeeth', 'filtry', 'ftmeur', 'ziltry', 'gmttry', 'wavestry', 'astrbtc', 'bswtry', 'funbnb', 'portobusd', 'steemusdt', 'audiotry', 'bttcbusd', 'mblbusd', 'mobusdt', 'mobbusd', 'mobbtc', 'nexousdt', 'nexobtc', 'reiusdt', 'galusdt', 'galbusd', 'galbtc', 'kncbnb', 'galeur', 'galtry', 'ldobusd', 'ldousdt', 'ldobtc', 'enstry', 'dareur', 'algoeth', 'algotry', 'epxusdt', 'epxbusd', 'cvcbusd', 'reibusd', 'drepbusd', 'akrobusd', 'pundixbusd', 'luncbusd', 'ustcbusd', 'opbtc', 'opbusd', 'opusdt', 'ogbusd', 'keybusd', 'asrbusd', 'firobusd', 'nknbusd', 'opbnb', 'opeur', 'snxeth', 'wbtcbusd', 'leverusdt', 'leverbusd', 'storjtry', 'opeth', 'etctry', 'fileth', 'glmbusd', 'ssvbusd', 'stgbtc', 'stgbusd', 'stgusdt', 'ankrtry', 'arkbusd', 'bethbusd', 'loombusd', 'snmbusd', 'ambbusd', 'luncusdt', 'phbbusd', 'gasbusd', 'prosbusd', 'vibbusd', 'gmxbtc', 'gmxbusd', 'gmxusdt', 'agixbusd', 'sntbusd', 'polyxbtc', 'polyxbusd', 'polyxusdt', 'aptbtc', 'aptusdt', 'aptbusd', 'btcpln', 'ethpln', 'busdpln', 'apteur', 'apttry', 'osmobtc', 'osmousdt', 'osmobusd', 'hftbtc', 'hftbusd', 'hftusdt', 'arpaeth', 'phbusdt', 'hookbtc', 'hookusdt', 'hookbusd', 'hookbnb', 'magicbtc', 'magicbusd', 'magicusdt', 'busdron', 'hifieth', 'hifiusdt', 'rplbtc', 'rplbusd', 'rplusdt', 'prosusdt', 'fettry', 'gftbusd', 'agixusdt', 'apteth', 'btcron', 'gnsusdt', 'gnsbtc', 'synbtc', 'synusdt', 'vibusdt', 'ssvusdt', 'lqtyusdt', 'lqtybtc', 'ambusdt', 'bethusdt', 'cfxtry', 'stxtry', 'ustcusdt', 'gasusdt', 'glmusdt', 'promusdt', 'qkcusdt', 'uftusdt', 'idbtc', 'idbnb', 'idusdt', 'arbbtc', 'arbusdt', 'agixtry', 'loomusdt', 'oaxusdt', 'arbtusd', 'arbtry', 'arbeur', 'idtusd', 'idtry', 'ideur', 'ldotusd', 'matictusd', 'optusd', 'soltusd', 'ssvtusd', 'rdntbtc', 'rdntusdt', 'rdnttusd', 'arbrub', 'joetry', 'magictry', 'usdtpln', 'achtry', 'xvstry', 'egldron', 'usdtron', 'usdtars', 'dogetusd', 'wbtcusdt', 'eduusdt', 'edutusd', 'edubnb', 'edubtc', 'edueur', 'edutry', 'suiusdt', 'suitusd', 'suibtc', 'suibnb', 'suieur', 'suitry', 'aergousdt', 'rndrtry', 'pepeusdt', 'pepetusd', 'flokiusdt', 'flokitusd', 'ogtry', 'pepetry', 'wbetheth', 'astusdt', 'sntusdt', 'flokitry', 'citytry', 'combousdt', 'combobnb', 'combotry', 'ltctry', 'radtry', 'btcars', 'optry', 'paxgtry', 'mavbtc', 'mavusdt', 'mavtusd', 'cfxtusd', 'pendlebtc', 'pendleusdt', 'pendletusd', 'mavtry', 'oceantry', 'tusdtry', 'arbeth', 'bchtry', 'xvgtry', 'xvgtusd']

# WebSocket connections dictionary
ws_connections = {}

# Data storage
data = {pair: {} for pair in currency_pairs}

# Pulsar client
client = Client('pulsar://localhost:6650')
producer = client.create_producer('binance')

def on_message(ws, message):
    # Parse the message
    msg = json.loads(message)

    # Update the data
    global data
    data[msg['s'].lower()] = {'symbol': msg['s'], 'askprice': msg['a'], 'askqty': msg['A'], 'bidprice': msg['b'], 'bidqty': msg['B']}

    # Update the values in the database
    df = pd.DataFrame([data[msg['s'].lower()]])
    print(df)
    engine = connect_to_db(database='crypto_intra')
    update_or_insert_trade_pairs(engine, df)

    # Send the data to Pulsar
    producer.send(bytes(json.dumps(data[msg['s'].lower()]), 'utf-8'))

def on_error(ws, error):
    print(error)

def on_close(ws, close_status_code, close_msg):
    print('WebSocket connection closed')

def on_open(ws):
    print('WebSocket connection opened')

# Create a WebSocket connection for each currency pair
for pair in currency_pairs:
    ws = websocket.WebSocketApp(f'wss://stream.binance.com:9443/ws/{pair}@bookTicker',
                                on_message=on_message,
                                on_error=on_error,
                                on_close=on_close)
    ws.on_open = on_open
    ws_connections[pair] = ws

# Start all WebSocket connections
for ws in ws_connections.values():
    threading.Thread(target=ws.run_forever).start()